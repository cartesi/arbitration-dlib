#!/bin/bash

TEMP_OUT=`mktemp`
echo "Redirect sdtout to:" $TEMP_OUT

export CARTESI_TESTING="true"
export CARTESI_WORKING_PATH=`mktemp -d`
export CARTESI_CONFIG_PATH=`mktemp --tmpdir=$CARTESI_WORKING_PATH`

echo "Configuration file:" $CARTESI_CONFIG_PATH

# Change to stderr
echo -n "Starting Ganache..."
./node_modules/.bin/ganache-cli -s secret -b .5 > $TEMP_OUT &
PID=$!

# In case of user interruption, terminate ganache
trap ctrl_c INT
function ctrl_c {
    echo "Terminating ganache..."
    kill $PID
    cd ~
}

until grep -q "Gas Limit" "$TEMP_OUT"
do
  sleep 1s
done

echo " Ganache ready."

function get_address {
    ./node_modules/.bin/truffle migrate \
        | grep "ComputeInstantiator:" \
        | sed -e 's/^[[:space:]]*//' \
        | cut -d ' ' -f 2
}


# Change to stderr
echo -n "Starting Truffle..."
export CARTESI_MAIN_CONCERN_CONTRACT=`get_address`
export CARTESI_MAIN_CONCERN_USER=0x2ad38f50f38abc5cbcf175e1962293eecc7936de
export CARTESI_MAIN_CONCERN_ABI="${HOME}/contracts/build/contracts/ComputeInstantiator.json"
echo " Truffle finished."

export CARTESI_CONCERN_KEY=0x339565dd96968ad4fba67e320bc9cf07808298d3654634e1bcc3b46350964f6e

echo "ComputeInstantiator" $CARTESI_MAIN_CONCERN_CONTRACT

echo -n "Moking instances..."

./mock_instances.js > /dev/null

echo " instantiation finished."

export RUST_LOG=dispatcher,transaction,configuration,utils,state,compute,hasher

# Change this
bash --noprofile --norc

ctrl_c
